###################
### ORIGIN ###
###################

<VirtualHost *:80>
  ServerName dex.origin.test

  ServerAdmin root@admin
  ProxyPreserveHost On
  ProxyRequests Off

  ProxyPass / http://oidc-origin:5556/
  ProxyPassReverse / http://oidc-origin:5556/
</VirtualHost>

<VirtualHost *:80>
  ServerName http://origin.test

  ServerAdmin root@admin
  ProxyPreserveHost On
  ProxyRequests Off
  # ProxyRequests disabled for ProxyPass
  RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}

  OIDCSSLValidateServer Off
  OIDCClientSecret ZXhhbXBsZS1hcHAtc2VjcmV0
  OIDCCryptoPassphrase RANDOMSTRING
  OIDCClientID eurydice-dev
  OIDCProviderMetadataURL http://oidc-origin:5556/dex/.well-known/openid-configuration
  # OIDCProviderMetadataURL is called by apache container, so url must be the container name
  OIDCRedirectURI http://origin.test/api/v1/user/login/sso/authorize
  OIDCXForwardedHeaders X-Forwarded-Host
  OIDCXForwardedHeaders X-Forwarded-Proto
  OIDCScope "openid profile"
  # unset header used for Remote Header authentication
  # in order to be sure that it cannot be forged
  RequestHeader unset X-Remote-User

  <Location />
    ProxyPass http://devcontainer:8080/
    ProxyPassReverse http://devcontainer:8080/
  </Location>

  <Location /api/>
    ProxyPass http://devcontainer:8000/api/
    ProxyPassReverse http://devcontainer:8000/api/
  </Location>

  <Location /admin>
    ProxyPass http://devcontainer:8000/admin
    ProxyPassReverse http://devcontainer:8000/admin
  </Location>

  <Location /static>
    ProxyPass http://devcontainer:8000/static
    ProxyPassReverse http://devcontainer:8000/static
  </Location>

  <Location /api/v1/user/login/sso>
    AuthType openid-connect
    Require valid-user
    RequestHeader set X-Remote-User %{OIDC_CLAIM_preferred_username}e

    ProxyPass http://devcontainer:8000/api/v1/user/login
    ProxyPassReverse http:///devcontainer:8000/api/v1/user/login
  </Location>

  <Location /api/v1/user/login/kerberos>
    RequestHeader set X-Remote-User BillMuray

    ProxyPass http://devcontainer:8000/api/v1/user/login
    ProxyPassReverse http:///devcontainer:8000/api/v1/user/login
  </Location>
</VirtualHost>

###################
### DESTINATION ###
###################

<VirtualHost *:80>
  ServerName dex.destination.test

  ServerAdmin root@admin
  ProxyPreserveHost On
  ProxyRequests Off

  ProxyPass / http://oidc-destination:5556/
  ProxyPassReverse / http://oidc-destination:5556/
</VirtualHost>


<VirtualHost *:80>
  ServerName http://destination.test

  ServerAdmin root@admin
  ProxyPreserveHost On
  ProxyRequests Off
  # ProxyRequests disabled for ProxyPass
  RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}

  OIDCSSLValidateServer Off
  OIDCClientSecret ZXhhbXBsZS1hcHAtc2VjcmV0
  OIDCCryptoPassphrase RANDOMSTRING
  OIDCClientID eurydice-dev
  OIDCProviderMetadataURL http://oidc-destination:5556/dex/.well-known/openid-configuration
  # OIDCProviderMetadataURL is called by apache container, so url must be the container name
  OIDCRedirectURI http://destination.test/api/v1/user/login/sso/authorize
  OIDCXForwardedHeaders X-Forwarded-Host
  OIDCXForwardedHeaders X-Forwarded-Proto
  OIDCScope "openid profile"
  # unset header used for Remote Header authentication
  # in order to be sure that it cannot be forged
  RequestHeader unset X-Remote-User

  <Location />
    ProxyPass http://devcontainer:8081/
    ProxyPassReverse http://devcontainer:8081/
  </Location>

  <Location /api/>
    ProxyPass http://devcontainer:8001/api/
    ProxyPassReverse http://devcontainer:8001/api/
  </Location>

  <Location /admin>
    ProxyPass http://devcontainer:8001/admin
    ProxyPassReverse http://devcontainer:8001/admin
  </Location>

  <Location /static>
    ProxyPass http://devcontainer:8001/static
    ProxyPassReverse http://devcontainer:8001/static
  </Location>

  <Location /api/v1/user/login/sso>
    AuthType openid-connect
    Require valid-user
    RequestHeader set X-Remote-User %{OIDC_CLAIM_preferred_username}e

    ProxyPass http://devcontainer:8001/api/v1/user/login
    ProxyPassReverse http:///devcontainer:8001/api/v1/user/login
  </Location>

  <Location /api/v1/user/login/kerberos>
    RequestHeader set X-Remote-User BillMuray

    ProxyPass http://devcontainer:8001/api/v1/user/login
    ProxyPassReverse http:///devcontainer:8001/api/v1/user/login
  </Location>
</VirtualHost>
